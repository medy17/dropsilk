<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>DropSilk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#ffffff">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- Base Palette --- */
            --brilliant-blue: #5bcefa;
            --brilliant-pink: #f5a9b8;
            --brilliant-white: #ffffff;
            --dark-bg-base: #18181b;
            --dark-bg-root: #111113;

            /* --- Themed Variables (Light Mode Default) --- */
            --c-bg: var(--brilliant-white);
            --c-text-primary: var(--dark-bg-base);
            --c-text-secondary: #888;
            --c-primary: var(--brilliant-blue);
            --c-secondary: var(--brilliant-pink);

            --c-panel-bg: var(--brilliant-white);
            --c-panel-border: var(--brilliant-pink);
            --c-panel-shadow: 0 8px 25px rgba(91, 206, 250, 0.07);

            --c-header-bg: var(--c-panel-bg);
            --c-header-border: transparent;
            --c-footer-bg: var(--c-panel-bg);
            --c-footer-border: #f0f0f0;

            --c-dropzone-bg: #fafdff;
            --c-dropzone-border: var(--c-panel-border);
            --c-dropzone-hover-bg: linear-gradient(135deg, rgba(91,206,250,0.12), rgba(245,169,184,0.08));

            --c-progress-track: #e0e0e0;

            --c-btn-primary-bg: linear-gradient(90deg, rgba(91,206,250,0.12) 0%, rgba(245,169,184,0.10) 100%);
            --c-btn-secondary-bg: linear-gradient(90deg, rgba(245,169,184,0.12) 0%, rgba(91,206,250,0.08) 100%);

            --c-success: #50c878;
            --c-danger: #ef4444;
        }

        body[data-theme="dark"] {
            /* --- Themed Variables (Dark Mode Overrides) --- */
            --c-bg: var(--dark-bg-root);
            --c-text-primary: #f4f4f5;
            --c-text-secondary: #a1a1aa;

            --c-panel-bg: var(--dark-bg-base);
            --c-panel-border: rgba(245, 169, 184, 0.4);
            --c-panel-shadow: 0 0 0 1px rgba(255, 255, 255, 0.05), 0 4px 12px rgba(0, 0, 0, 0.2);

            --c-header-bg: #111113;
            --c-header-border: var(--c-primary);
            --c-footer-bg: #111113;
            --c-footer-border: rgba(255, 255, 255, 0.1);

            --c-dropzone-bg: rgba(255, 255, 255, 0.02);
            --c-dropzone-border: rgba(245, 169, 184, 0.25);
            --c-dropzone-hover-bg: linear-gradient(135deg, rgba(91,206,250,0.1), rgba(245,169,184,0.08));

            --c-progress-track: #37373d;

            --c-btn-primary-bg: linear-gradient(90deg, rgba(91,206,250,0.15) 0%, rgba(245,169,184,0.12) 100%);
            --c-btn-secondary-bg: linear-gradient(90deg, rgba(245,169,184,0.15) 0%, rgba(91,206,250,0.10) 100%);

            --c-success: #3ec6a8;
        }

        /* --- Global Styles --- */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, Arial, sans-serif;
            background: var(--c-bg);
            color: var(--c-text-primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .header {
            width: 100%;
            padding: 1.5em 1.5em;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1000;
            background: var(--c-header-bg);
            border-bottom: 0px solid var(--c-header-border);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        .header .logo {
            font-size: 1.5em;
            font-weight: 800;
            color: var(--c-primary);
            display: flex;
            align-items: center;
            gap: 0.5em;
            text-decoration: none;
        }
        .header .logo img {
            height: 1.8em;
            vertical-align: middle;
        }

        .header-nav {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        @media (min-width: 768px) {
            .header {
                padding: 1.5em 2em;
            }
            .header-nav {
                gap: 1.5rem;
            }
        }

        .header-nav-link {
            background: none;
            border: none;
            font-family: 'IBM Plex Sans', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--c-text-secondary);
            cursor: pointer;
            padding: 0.5em;
            transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out, transform 0.1s ease-out;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px; /* Added for pill shape */
            min-width: 38px;
            min-height: 38px;
        }
        .brand-text {
            font-size: clamp(1rem, 4vw, 2rem); /* Dynamic resizing */
            white-space: nowrap;               /* No wrapping by default */
            transition: font-size 0.2s;
        }

        @media (max-width: 400px) {
            .brand-text {
                white-space: normal;             /* Allow wrapping below 400px */
            }
        }

        @media (max-width: 350px) {
            .brand-text {
                display: none;                   /* Hide below 350px */
            }
        }

        .header-nav-link:hover,
        .header-nav-link:focus {
            color: var(--c-primary);
            outline: none;
            background-color: rgba(91, 206, 250, 0.08);
        }
        .header-nav-link svg {
            transition: color 0.2s ease-in-out;
            width: 22px; height: 22px;
        }
        .header-nav-link:hover svg,
        .header-nav-link:focus svg {
            color: var(--c-primary);
        }

        /* --- NEW: Theme Toggle Button --- */
        #theme-toggle .sun-icon { display: none; }
        #theme-toggle .moon-icon { display: block; }
        body[data-theme="dark"] #theme-toggle .sun-icon { display: block; }
        body[data-theme="dark"] #theme-toggle .moon-icon { display: none; }


        /* --- Initial Setup Screen --- */
        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            flex-grow: 1;
            padding: 8rem 2em 2em;
            gap: 3em;
            background: var(--c-bg);
        }

        .tagline-section {
            flex-basis: 50%;
            text-align: center;
            background: var(--c-panel-bg);
            border-radius: 18px;
            box-shadow: 0 2px 16px rgba(91, 206, 250, 0.04);
            padding: 2em 2em 2em 2em;
            margin-bottom: 2em;
            max-width: 600px;
            border: 1.5px solid rgba(245, 169, 184, 0.18);
        }

        body[data-theme="dark"] .tagline-section {
            border: 1.5px solid rgba(245, 169, 184, 0.3);
        }

        .tagline-section h1 {
            font-size: clamp(3em, 8vw, 5.5em);
            font-weight: 800;
            line-height: 1.1;
            margin: 0 0 0.5em 0;
            color: var(--c-primary);
            letter-spacing: 0.01em;
            text-shadow: 0 2px 8px rgba(91, 206, 250, 0.08);
        }
        body[data-theme="dark"] .tagline-section h1 { text-shadow: none; }

        .tagline-section p {
            font-size: 1.1em;
            color: var(--c-text-secondary);
            max-width: 450px;
            margin: 0 auto;
        }

        .flight-ticket-panel-wrapper {
            position: relative;
            width: 100%;
            max-width: 380px;
        }
        body[data-theme="dark"] .flight-ticket-panel-wrapper {
            filter: drop-shadow(0 0 15px rgba(91, 206, 250, 0.1));
        }

        .flight-ticket {
            background: var(--c-panel-bg);
            color: var(--c-text-primary);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 4px 32px 0 rgba(91, 206, 250, 0.07), 0 1.5px 0 0 var(--c-secondary);
            border: 1.5px solid var(--c-primary);
            transition: box-shadow 0.2s, background 0.3s ease, color 0.3s ease;
        }
        body[data-theme="dark"] .flight-ticket {
            box-shadow: 0 4px 32px 0 rgba(0, 0, 0, 0.2), 0 1.5px 0 0 var(--c-secondary);
        }

        .flight-ticket h2 {
            font-family: "IBM Plex Mono", monospace;
            margin: 0;
            font-weight: 700;
            color: var(--c-primary);
            letter-spacing: 0.02em;
            text-shadow: 0 1px 0 #fff, 0 0 2px #fff;
        }
        body[data-theme="dark"] .flight-ticket h2 { text-shadow: none; }

        .flight-ticket p {
            opacity: 0.8;
            margin: 0.5rem 0 1.5rem 0;
            color: var(--c-text-primary);
        }

        .ticket-actions {
            font-family: "IBM Plex Sans";
            display: flex;
            flex-direction: column;
            gap: 0.8em;
        }

        .ticket-actions button {
            width: 100%;
            padding: 1em;
            font-size: 1em;
            border-radius: 12px;
            border: 1.5px solid var(--c-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s, transform 0.1s ease-out;
            background: var(--c-btn-primary-bg);
            color: var(--c-primary);
            box-shadow: 0 1px 4px rgba(91, 206, 250, 0.06);
        }

        .ticket-actions button:hover, .ticket-actions button:focus {
            background: var(--c-primary);
            color: var(--brilliant-white);
            border-color: var(--c-secondary);
            outline: none;
        }

        .or-separator {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 1em 0;
            color: var(--c-primary);
            opacity: 0.6;
            font-weight: 500;
            font-size: 0.95em;
        }

        .or-separator::before, .or-separator::after {
            content: '';
            flex: 1;
            border-bottom: 2px dashed var(--c-secondary);
        }

        .or-separator:not(:empty)::before { margin-right: .5em; }
        .or-separator:not(:empty)::after { margin-left: .5em; }

        .flight-code-input-wrapper {
            display: flex;
            background: var(--c-panel-bg);
            border-radius: 12px;
            overflow: hidden;
            border: 1.5px solid var(--c-primary);
            box-shadow: 0 1px 4px rgba(91, 206, 250, 0.04);
            transition: border-color 0.2s, background 0.3s ease;
        }

        .flight-code-input-wrapper:focus-within {
            border-color: var(--c-secondary);
        }

        .flight-code-input-wrapper input {
            flex: 1 1 auto;
            font-family: "IBM Plex Mono", monospace;
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 1em;
            width: calc(1ch * 6 + 1.5em);
            background: none;
            border: none;
            color: var(--c-text-primary);
            padding: 1em 1em;
            outline: none;
            text-align: center;
            box-sizing: content-box;
            text-transform: uppercase;
        }

        .flight-code-input-wrapper button {
            width: auto;
            background: none;
            color: var(--c-primary);
            padding: 0.5em 0.8em;
            cursor: pointer;
            font-size: 1.8em;
            border-radius: 10px;
            border: none;
            transition: color 0.2s, transform 0.1s ease-out;
        }

        .flight-code-input-wrapper button:hover, .flight-code-input-wrapper button:focus {
            color: var(--c-secondary);
            background: rgba(91, 206, 250, 0.08);
            outline: none;
        }

        @media (min-width: 992px) {
            .main-content { flex-direction: row; }
            .tagline-section {
                text-align: left;
                padding-right: 3em;
                margin-bottom: 0;
            }
            .tagline-section p { margin: 0; }
        }

        /* --- NEW DASHBOARD UI --- */
        #dashboard {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 8rem 1rem 2rem;
            display: none;
            flex-direction: column;
            gap: 1.5rem;
            flex-grow: 1;
        }
        @media (min-width: 768px) {
            #dashboard {
                padding: 8rem 2rem 2rem;
            }
        }

        .panel {
            background-color: var(--c-panel-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--c-panel-shadow);
            border: 2px solid var(--c-panel-border);
            min-width: 0;
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        #dashboard-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            border-bottom: 2px solid var(--c-primary);
        }
        #dashboard-flight-code {
            display: inline-block;
            background: linear-gradient(
                    90deg,
                    rgba(91,206,250,0.12) 0%,
                    rgba(245,169,184,0.10) 100%
            );
            color: var(--c-primary);
            font-family: "IBM Plex Mono", monospace;
            font-size: 1em;
            font-weight: 700;
            border-radius: 10px;
            padding: 0.25em 0.7em;
            letter-spacing: 0.15em;
            margin-left: 0.5em;
            border: 1.5px solid var(--c-secondary);
            box-shadow: 0 1px 4px rgba(91, 206, 250, 0.06);
            backdrop-filter: blur(6px) saturate(1.2);
            -webkit-backdrop-filter: blur(6px) saturate(1.2);
            outline: 1px solid rgba(255,255,255,0.18);
            transition:
                    box-shadow 0.2s,
                    border-color 0.2s,
                    background 0.2s,
                    color 0.2s,
                    transform 0.15s;
            cursor: pointer;
            user-select: none;
            position: relative;
            overflow: hidden;
        }
        body[data-theme="dark"] #dashboard-flight-code {
            outline: none;
        }

        #dashboard-flight-code:active {
            transform: scale(0.97);
        }
        #dashboard-flight-code.copied {
            background: linear-gradient(
                    90deg,
                    rgba(62,198,168,0.18) 0%,
                    rgba(127,234,210,0.18) 100%
            );
            color: var(--c-success);
            border-color: var(--c-success);
            box-shadow: 0 0 0 2px #3ec6a833;
        }
        #dashboard-flight-code .copy-feedback {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%,-50%);
            background: rgba(255,255,255,0.95);
            color: var(--c-success);
            font-size: 0.95em;
            font-weight: 700;
            border-radius: 6px;
            padding: 0.2em 0.8em;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 2;
        }
        body[data-theme="dark"] #dashboard-flight-code .copy-feedback {
            background: var(--dark-bg-root);
        }
        #dashboard-flight-code.copied .copy-feedback {
            opacity: 1;
        }
        .flight-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .flight-info__code {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .flight-info__code span {
            font-weight: 800;
            color: var(--c-primary);
        }
        .flight-info__status {
            background-color: var(--c-panel-bg);
            color: var(--c-secondary);
            font-weight: 600;
            padding: 0.5em 1em;
            border-radius: 99px;
            font-size: 0.9em;
            border: 1.5px solid var(--c-primary);
        }
        .flight-actions {
            display: flex;
            gap: 0.8rem;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(24, 24, 27, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }

        .invite-modal {
            background: var(--c-panel-bg);
            border-radius: 20px;
            padding: 2rem;
            box-shadow:
                    0 20px 60px rgba(91, 206, 250, 0.15),
                    0 8px 32px rgba(245, 169, 184, 0.1),
                    0 0 0 1px rgba(91, 206, 250, 0.1);
            border: 2px solid var(--c-primary);
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease;
        }

        .modal-overlay.show .invite-modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--c-primary);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--c-primary);
            font-size: 1.4rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--c-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .modal-close:hover {
            background: linear-gradient(135deg, rgba(245,169,184,0.15), rgba(91,206,250,0.1));
            color: var(--c-primary);
            transform: rotate(90deg);
        }

        .modal-close:active {
            transform: rotate(90deg) scale(0.95);
        }

        .modal-body {
            padding-top: 0.5rem;
            color: var(--c-text-secondary);
        }
        .modal-body p {
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .modal-body .flight-code-display a.code {
            text-decoration: none;
            color: var(--c-primary);
            transition: color 0.2s, transform 0.1s ease-out;
        }
        .modal-body .flight-code-display a.code:hover {
            color: var(--c-secondary);
        }
        .modal-body .flight-code-display a.code:active {
            transform: scale(0.97);
        }

        /* --- NEW: Staggered Modal Content Animation --- */
        .modal-overlay .modal-header,
        .modal-overlay .modal-body,
        .modal-overlay .flight-code-display,
        .modal-overlay .qr-section,
        .modal-overlay .share-actions {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        .modal-overlay.show .modal-header,
        .modal-overlay.show .modal-body,
        .modal-overlay.show .flight-code-display,
        .modal-overlay.show .qr-section,
        .modal-overlay.show .share-actions {
            opacity: 1;
            transform: translateY(0);
        }
        .modal-overlay.show .modal-header { transition-delay: 0.05s; }
        .modal-overlay.show .flight-code-display { transition-delay: 0.1s; }
        .modal-overlay.show .modal-body { transition-delay: 0.1s; }
        .modal-overlay.show .qr-section { transition-delay: 0.15s; }
        .modal-overlay.show .share-actions { transition-delay: 0.2s; }


        .qr-section {
            text-align: center;
            margin-bottom: 2rem;
        }

        .qr-container {
            background: linear-gradient(135deg, rgba(91,206,250,0.08), rgba(245,169,184,0.05));
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
            border: 1.5px solid rgba(91, 206, 250, 0.2);
            box-shadow:
                    0 4px 16px rgba(91, 206, 250, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .qr-container canvas {
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(91, 206, 250, 0.15);
        }

        .qr-description {
            color: var(--c-text-secondary);
            font-size: 0.9rem;
            margin-top: 1rem;
            line-height: 1.4;
        }

        .share-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .share-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: 1.5px solid var(--c-primary);
            background: var(--c-btn-primary-bg);
            color: var(--c-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease, transform 0.1s ease-out;
            text-decoration: none;
            font-size: 0.95rem;
            position: relative;
            overflow: hidden;
        }

        .share-btn:hover {
            background: var(--c-primary);
            color: var(--brilliant-white);
            border-color: var(--c-secondary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(91, 206, 250, 0.25);
        }

        .share-btn:active {
            transform: translateY(0) scale(0.97);
        }

        .share-btn.secondary {
            border-color: var(--c-secondary);
            color: var(--c-secondary);
            background: var(--c-btn-secondary-bg);
        }

        .share-btn.secondary:hover {
            background: var(--c-secondary);
            color: var(--brilliant-white);
            border-color: var(--c-primary);
        }

        .share-btn.success {
            background: linear-gradient(90deg, rgba(80,200,120,0.15) 0%, rgba(127,234,210,0.12) 100%);
            border-color: var(--c-success);
            color: var(--c-success);
        }

        .share-btn svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .flight-code-display {
            background: linear-gradient(135deg, rgba(91,206,250,0.15), rgba(245,169,184,0.1));
            border: 1.5px solid var(--c-primary);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        .flight-code-display .code {
            font-family: "IBM Plex Mono", monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--c-primary);
            letter-spacing: 0.2em;
            margin-bottom: 0.5rem;
        }

        .flight-code-display .label {
            color: var(--c-text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
        }

        @media (max-width: 480px) {
            .invite-modal {
                padding: 1.5rem;
                margin: 1rem;
            }
            .share-actions { gap: 0.8rem; }
            .share-btn { padding: 0.9rem 1.2rem; font-size: 0.9rem; }
        }

        .btn {
            padding: 0.8em 1.5em;
            border-radius: 12px;
            border: 1.5px solid;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease, transform 0.1s ease-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5em;
            text-decoration: none;
            box-shadow: 0 1px 4px rgba(91, 206, 250, 0.06);
            backdrop-filter: blur(6px) saturate(1.2);
            -webkit-backdrop-filter: blur(6px) saturate(1.2);
            outline: 1px solid rgba(255,255,255,0.18);
        }
        body[data-theme="dark"] .btn {
            outline: none;
        }

        .btn-primary {
            background: var(--c-btn-primary-bg);
            color: var(--c-primary);
            border-color: var(--c-primary);
        }
        .btn-primary:hover {
            background: var(--c-primary);
            color: var(--brilliant-white);
            border-color: var(--c-secondary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(91, 206, 250, 0.25);
        }

        .btn-secondary {
            background: var(--c-btn-secondary-bg);
            color: var(--c-secondary);
            border-color: var(--c-secondary);
        }
        .btn-secondary:hover {
            background: var(--c-secondary);
            color: var(--brilliant-white);
            border-color: var(--c-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 169, 184, 0.25);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        @media (min-width: 992px) {
            .dashboard-grid { grid-template-columns: 2fr 1fr; }
            .grid-col-span-2 { grid-column: span 2 / span 2; }
        }

        .drop-zone {
            border: 2px dashed var(--c-dropzone-border);
            text-align: center;
            padding: 3rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            background-color: var(--c-dropzone-bg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .drop-zone.drag-over {
            border-color: var(--c-primary);
            background: var(--c-dropzone-hover-bg);
            transform: scale(1.02);
            box-shadow:
                    0 8px 32px rgba(91, 206, 250, 0.15),
                    0 0 0 2px rgba(91, 206, 250, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        body[data-theme="dark"] .drop-zone.drag-over {
            box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.3),
                    0 0 0 2px rgba(91, 206, 250, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .drop-zone.drag-over::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(91, 206, 250, 0.3),
                    transparent
            );
            animation: shimmer 1.5s infinite;
            pointer-events: none;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .drop-zone.drag-over .drop-zone__icon {
            color: var(--c-primary);
            transform: scale(1.1);
            filter: drop-shadow(0 4px 8px rgba(91, 206, 250, 0.3));
        }

        .drop-zone.drag-over p {
            color: var(--c-primary);
            font-weight: 700;
        }

        .drop-zone.drag-over .secondary-text {
            color: var(--c-secondary);
            font-weight: 600;
        }

        .drop-zone.drag-active {
            border-color: var(--c-secondary);
            background: linear-gradient(135deg, rgba(245,169,184,0.15), rgba(91,206,250,0.08));
            transform: scale(1.05);
        }

        .drop-zone.drag-active .drop-zone__icon {
            color: var(--c-secondary);
            animation: bounce 0.6s ease-in-out infinite alternate;
        }

        @keyframes bounce {
            0% { transform: scale(1.1) translateY(0); }
            100% { transform: scale(1.2) translateY(-4px); }
        }

        body.dragging * {
            pointer-events: none;
        }

        body.dragging .drop-zone {
            pointer-events: all;
        }
        .drop-zone__icon { color: var(--c-primary); }
        .drop-zone p { margin: 0; font-weight: 600; }
        .drop-zone__buttons { display: flex; gap: 1rem; }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .panel-header h3 { margin: 0; font-size: 1.1rem; color: var(--c-primary);}
        .panel-header .icon-btn { background: none; border: none; cursor: pointer; color: var(--c-text-secondary); font-size: 1.5rem; padding: 0.2em; }
        .empty-state {
            text-align: center;
            color: var(--c-text-secondary);
            padding: 1rem 0;
            font-size: 0.9em;
        }

        /* --- STYLES FOR CONNECTION PANEL --- */
        #connection-panel-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .network-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 12px;
            background: linear-gradient(90deg, rgba(91,206,250,0.05) 0%, rgba(245,169,184,0.04) 100%);
            transition: background 0.2s ease;
        }
        .network-user-item:hover {
            background: linear-gradient(90deg, rgba(91,206,250,0.1) 0%, rgba(245,169,184,0.08) 100%);
        }
        .network-user-details {
            display: flex;
            flex-direction: column;
        }
        .network-user-name {
            font-weight: 600;
        }
        .network-user-id {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8em;
            color: var(--c-text-secondary);
            opacity: 0.8;
        }
        .invite-user-btn {
            padding: 0.5em 1em;
            font-size: 0.85em;
        }
        .invite-user-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            background: transparent;
            border-color: var(--c-text-secondary);
            color: var(--c-text-secondary);
        }

        /* --- NEW: Styles for "In Flight" view --- */
        .inflight-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 12px;
            background: linear-gradient(90deg, rgba(91,206,250,0.05) 0%, rgba(245,169,184,0.04) 100%);
        }
        .inflight-user-details {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .inflight-user-name {
            font-weight: 600;
        }
        .user-badge {
            font-size: 0.75em;
            font-weight: 700;
            padding: 0.2em 0.6em;
            border-radius: 99px;
            background-color: var(--c-primary);
            color: var(--brilliant-white);
            text-transform: uppercase;
        }
        .inflight-user-id {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8em;
            color: var(--c-text-secondary);
            opacity: 0.8;
        }

        @keyframes marquee-scroll {
            from { transform: translateX(0); }
            to { transform: translateX(calc(-100% + 200px)); }
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0.5rem;
            border-bottom: 1px solid var(--c-panel-border);
        }
        .queue-item:last-child { border-bottom: none; }
        .file-icon {
            flex-shrink: 0;
            background: linear-gradient(135deg, rgba(91,206,250,0.10), rgba(245,169,184,0.10));
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 1.5rem;
            transition: box-shadow 0.2s;
            box-shadow: 0 1px 4px rgba(91, 206, 250, 0.06);
        }
        .file-icon svg {
            width: 28px;
            height: 28px;
            display: block;
        }
        .file-icon:hover, .file-icon:focus {
            box-shadow: 0 2px 8px rgba(91, 206, 250, 0.18);
            background: linear-gradient(135deg, rgba(91,206,250,0.18), rgba(245,169,184,0.18));
        }
        .file-details {
            flex-grow: 1;
            min-width: 0;
        }
        .file-details__name {
            font-weight: 600;
            margin-bottom: 0.3em;
            white-space: nowrap;
            overflow: hidden;
            -webkit-mask-image: linear-gradient(to right, black 90%, transparent 100%);
            mask-image: linear-gradient(to right, black 90%, transparent 100%);
        }
        body[data-theme="dark"] .file-details__name {
            -webkit-mask-image: linear-gradient(to right, var(--dark-bg-base) 90%, transparent 100%);
            mask-image: linear-gradient(to right, var(--dark-bg-base) 90%, transparent 100%);
        }
        .file-details__name span {
            display: inline-block;
            padding-right: 2rem;
        }
        .file-details__name:hover span {
            animation: marquee-scroll 8s linear infinite alternate;
        }
        .file-details__progress-bar {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            background-color: var(--c-progress-track);
            border: none;
            accent-color: var(--c-primary);
        }
        .file-details__progress-bar::-webkit-progress-bar {
            background-color: var(--c-progress-track);
            border-radius: 4px;
        }
        .file-details__progress-bar::-webkit-progress-value {
            background: linear-gradient(90deg, #3ec6a8 0%, #7fead2 100%);
            border-radius: 4px;
        }
        .file-details__progress-bar::-moz-progress-bar {
            background: linear-gradient(90deg, #3ec6a8 0%, #7fead2 100%);
            border-radius: 4px;
        }
        .file-details__status {
            font-size: 0.8em;
            color: var(--c-text-secondary);
            display: flex;
            justify-content: space-between;
            margin-top: 0.3em;
        }
        .file-action {
            flex-shrink: 0;
        }
        .file-action a {
            display: block;
            padding: 0.8em 1.2em;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
            transition: all 0.2s ease, transform 0.1s ease-out;
            background: var(--c-btn-primary-bg);
            color: var(--c-primary);
            border: 1.5px solid var(--c-primary);
            box-shadow: 0 1px 4px rgba(91, 206, 250, 0.06);
            backdrop-filter: blur(6px) saturate(1.2);
            -webkit-backdrop-filter: blur(6px) saturate(1.2);
            outline: 1px solid rgba(255,255,255,0.18);
        }
        body[data-theme="dark"] .file-action a {
            outline: none;
        }
        .file-action a:hover {
            background: var(--c-primary);
            color: var(--brilliant-white);
            border-color: var(--c-secondary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(91, 206, 250, 0.25);
        }

        .dashboard-footer-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        @media (min-width: 992px) {
            .dashboard-footer-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        .metrics-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 1rem; }
        .metrics-list li { display: flex; align-items: center; gap: 1rem; }
        .metrics-list .icon {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--c-primary);
            width: 28px;
            height: 28px;
            min-width: 28px;
            min-height: 28px;
            background: linear-gradient(135deg, rgba(91,206,250,0.10), rgba(245,169,184,0.10));
            border-radius: 8px;
            margin-right: 0.5em;
            transition: color 0.2s, background 0.2s;
        }
        .metrics-list li:nth-child(1) .icon { color: var(--c-primary); }
        .metrics-list li:nth-child(2) .icon { color: var(--c-secondary); }
        .metrics-list li:nth-child(3) .icon { color: #fbbf24; }
        .metrics-list .icon svg {
            width: 20px;
            height: 20px;
            display: block;
        }
        .metrics-list .icon:hover, .metrics-list .icon:focus {
            background: linear-gradient(135deg, rgba(91,206,250,0.18), rgba(245,169,184,0.18));
            filter: brightness(1.1);
        }
        .promo-panel .btn { margin-top: 1rem; }

        .site-footer {
            background-color: var(--c-footer-bg);
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--c-footer-border);
            font-size: 0.9em;
            color: var(--c-text-secondary);
            margin-top: auto;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .footer-copyright {
            flex-shrink: 0;
        }

        .footer-nav {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .footer-nav-link {
            background: none;
            border: none;
            font-family: 'IBM Plex Sans', sans-serif;
            font-weight: 500;
            font-size: 1em;
            color: var(--c-text-secondary);
            cursor: pointer;
            padding: 0.5em;
            border-radius: 6px;
            transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out, transform 0.1s ease-out;
            text-decoration: none;
        }

        .footer-nav-link:hover,
        .footer-nav-link:focus {
            color: var(--c-primary);
            background-color: rgba(91, 206, 250, 0.08);
            outline: none;
        }

        @media (max-width: 600px) {
            .footer-content {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
        }

        /* --- NEW: Custom Scrollbar for Modals --- */
        .invite-modal::-webkit-scrollbar {
            width: 8px;
        }

        .invite-modal::-webkit-scrollbar-track {
            background: transparent;
        }

        .invite-modal::-webkit-scrollbar-thumb {
            background-color: var(--c-primary);
            border-radius: 20px;
            border: 2px solid var(--c-panel-bg);
        }

        .invite-modal::-webkit-scrollbar-thumb:hover {
            background-color: #379fd6;
        }

        .invite-modal::-webkit-scrollbar-button {
            display: none;
            height: 0;
        }

        .invite-modal {
            scrollbar-width: thin;
            scrollbar-color: var(--c-primary) transparent;
        }

        /* --- NEW: Toast Notification Styles --- */
        #toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .toast {
            background: var(--c-panel-bg);
            color: var(--c-text-primary);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: var(--c-panel-shadow);
            border: 2px solid var(--c-primary);
            width: 320px;
            max-width: 90vw;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1);
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .toast-header strong {
            color: var(--c-primary);
            font-weight: 700;
        }
        .toast-close {
            background: none; border: none; font-size: 1.2rem; color: var(--c-text-secondary); cursor: pointer;
            padding: 0.2rem;
        }
        .toast-body {
            font-size: 0.95em;
            margin-bottom: 1rem;
        }
        .toast-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        .toast-actions .btn {
            font-size: 0.85em;
            padding: 0.6em 1.2em;
        }

        /* --- MODIFIED: Consistent Tactile Button Feedback on :active --- */
        .btn:active,
        .ticket-actions button:active,
        .header-nav-link:active,
        .footer-nav-link:active,
        .flight-code-input-wrapper button:active,
        .file-action a:active {
            transform: translateY(0) scale(0.97);
            transition-duration: 0.1s;
        }
    </style>
</head>
<body>
<div class="header">
    <a href="#" class="logo" onclick="location.reload()">
        <img src="/logo.webp" alt="DropSilk Logo" />
        <span class="brand-text">Drop<wbr>Silk</span>
    </a>
    <nav class="header-nav">
        <button id="aboutBtn" class="header-nav-link">About</button>
        <button id="contactBtn" class="header-nav-link">Contact</button>
        <!-- NEW: Theme Toggle Button -->
        <button id="theme-toggle" class="header-nav-link" aria-label="Toggle theme">
            <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707z"/>
            </svg>
            <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
            </svg>
        </button>
        <a href="https://github.com/medy17" target="_blank" rel="noopener noreferrer" class="header-nav-link" aria-label="GitHub Profile">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
            </svg>
        </a>
    </nav>
</div>
<div class="main-content">
    <div class="tagline-section">
        <h1>FAST.<br />PRIVATE.<br />NO LIMIT.</h1>
        <p>Instantly share files, device to device. No cloud. No server. Just like a dance: it takes two to tango.</p>
    </div>
    <div class="flight-ticket-panel-wrapper">
        <div class="flight-ticket">
            <h2 id="userNameDisplay"></h2>
            <p>Your file transfer ticket</p>
            <div class="ticket-actions">
                <button id="createFlightBtn">Create a Flight</button>
                <div class="or-separator">OR</div>
                <div class="flight-code-input-wrapper">
                    <input id="flightCodeInput" type="text" placeholder="TRJXØD" value="" maxlength="6" pattern="[A-Za-z0-9]{6}" />
                    <button id="joinFlightBtn" aria-label="Join Flight">➤</button>
                </div>
                <p style="font-size: 0.8em; opacity: 0.9; margin-top: 0.5em;">ENTER FLIGHT CODE TO JOIN</p>
            </div>
        </div>
    </div>
</div>
<div id="dashboard">
    <div id="dashboard-header" class="panel">
        <div class="flight-info">
            <div class="flight-info__code">FLIGHT <button id="dashboard-flight-code" type="button" title="Copy code to clipboard"></button></div>
            <div class="flight-info__status" id="dashboard-flight-status">Ready to connect</div>
        </div>
        <div class="flight-actions">
            <button class="btn btn-primary" id="inviteBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5z"/></svg>
                Invite
            </button>
            <button class="btn btn-secondary" id="leaveFlightBtnDashboard">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/><path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/></svg>
                Leave
            </button>
        </div>
    </div>
    <div class="dashboard-grid">
        <div class="panel drop-zone">
            <div class="drop-zone__icon"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16"><path d="M8.5 11.5a.5.5 0 0 1-1 0V7.707L6.354 8.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 7.707V11.5z"/><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 1.5v3A1.5 1.5 0 0 0 11 6h3v8a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v.5z"/></svg></div>
            <p>Drag & Drop files or folders</p>
            <span class="secondary-text">or select manually</span>
            <div class="drop-zone__buttons">
                <label for="fileInput_transfer" class="btn btn-primary">
                    <!-- On-brand SVG -->
                    <svg viewBox="0 0 20 20" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="4" y="4" width="12" height="12" rx="2" fill="#e3f7fd" stroke="var(--c-primary)"/>
                        <path d="M10 8v4M8 10h4" stroke="var(--c-primary)" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    Select Files
                </label>
                <button class="btn btn-secondary">
                    <!-- On-brand SVG -->
                    <svg viewBox="0 0 20 20" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="7" width="14" height="8" rx="2" fill="#fffaf7" stroke="var(--c-secondary)"/>
                        <path d="M3 7V6a2 2 0 0 1 2-2h3l2 2h5a2 2 0 0 1 2 2v1" stroke="var(--c-secondary)" stroke-width="1.5" fill="none"/>
                    </svg>
                    Select Folder
                </button>
            </div>
            <input type="file" id="fileInput_transfer" style="display: none;" multiple />
        </div>
        <!-- MODIFIED: This panel is now dynamic -->
        <div class="panel">
            <div class="panel-header"><h3 id="connection-panel-title">Users on Your Network</h3></div>
            <div id="connection-panel-list">
                <div class="empty-state">No other users found.</div>
            </div>
        </div>
        <div class="panel grid-col-span-2">
            <div class="panel-header"><h3>Sending Queue</h3></div>
            <div id="sending-queue"><div class="empty-state">Select files to send</div></div>
        </div>
        <div class="panel grid-col-span-2">
            <div class="panel-header"><h3>Receiver Queue</h3></div>
            <div id="receiver-queue"><div class="empty-state">Waiting for incoming files</div></div>
        </div>
    </div>
    <div class="dashboard-footer-grid">
        <div class="panel">
            <div class="panel-header"><h3>Overall Metrics</h3></div>
            <ul class="metrics-list">
                <li>
        <span class="icon">
            <!-- Up Arrow SVG -->
            <svg viewBox="0 0 20 20" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10 17V3M10 3L4 9M10 3l6 6"/>
            </svg>
        </span>
                    <div>Sent: <span id="metrics-sent">0.00 GB</span></div>
                </li>
                <li>
        <span class="icon">
            <!-- Down Arrow SVG -->
            <svg viewBox="0 0 20 20" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10 3v14M10 17l6-6M10 17l-6-6"/>
            </svg>
        </span>
                    <div>Received: <span id="metrics-received">0.00 GB</span></div>
                </li>
                <li>
        <span class="icon">
            <!-- Lightning SVG -->
            <svg viewBox="0 0 20 20" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="10 2 4 12 9 12 8 18 16 8 11 8 12 2"/>
            </svg>
        </span>
                    <div>Speed: <span id="metrics-speed">0 KB/s</span></div>
                </li>
            </ul>
        </div>
        <div class="panel promo-panel">
            <div class="panel-header"><h3>Love DropSilk?</h3></div>
            <p>If you enjoy DropSilk, help us spread the word :). Remember to connect both devices to Wi-Fi for the best speeds.</p>
            <button class="btn btn-secondary" id="shareAppBtn">Share App</button>
        </div>
    </div>
</div>

<footer class="site-footer">
    <div class="footer-content">
        <div class="footer-copyright">
            © 2025 DropSilk. A peer-to-peer passion project.
        </div>
        <nav class="footer-nav">
            <button id="termsBtn" class="footer-nav-link">Terms</button>
            <button id="privacyBtn" class="footer-nav-link">Privacy</button>
            <button id="securityBtn" class="footer-nav-link">Security</button>
            <button id="faqBtn" class="footer-nav-link">FAQ</button>
        </nav>
    </div>
</footer>

<!-- Toast container for invitations -->
<div id="toast-container"></div>

<!-- All Modals are placed here -->
<div class="modal-overlay" id="inviteModal">
    <div class="invite-modal">
        <div class="modal-header">
            <h3>Invite Others</h3>
            <button class="modal-close" id="closeInviteModal" aria-label="Close modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg>
            </button>
        </div>
        <div class="flight-code-display">
            <div class="code" id="modalFlightCode">XXXXXX</div>
            <div class="label">Flight Code</div>
        </div>
        <div class="qr-section">
            <div class="qr-container"><canvas id="qrCanvas"></canvas></div>
            <p class="qr-description">Scan this QR code to visit DropSilk and join with the flight code above</p>
        </div>
        <div class="share-actions">
            <button class="share-btn" id="copyLinkBtn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>Copy Link</button>
            <button class="share-btn secondary" id="shareNativeBtn" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/></svg>Share</button>
            <button class="share-btn secondary" id="copyCodeBtn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M2 0a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h2.5a1 1 0 0 0 0-2H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v2.5a1 1 0 0 0 2 0V2a2 2 0 0 0-2-2H2z"/><path d="M4.5 4A1.5 1.5 0 0 0 3 5.5V13a1.5 1.5 0 0 0 1.5 1.5H12A1.5 1.5 0 0 0 13.5 13V7.5A1.5 1.5 0 0 0 12 6H7.5A1.5 1.5 0 0 0 6 7.5V13a.5.5 0 0 1-.5.5H4.5A.5.5 0 0 1 4 13V5.5a.5.5 0 0 1 .5-.5z"/></svg>Copy Code Only</button>
        </div>
    </div>
</div>

<!-- NEW: About Me Modal -->
<div class="modal-overlay" id="aboutModal">
    <div class="invite-modal">
        <div class="modal-header">
            <h3>About Me</h3>
            <button class="modal-close" id="closeAboutModal" aria-label="Close modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <p><strong>SilkDrop</strong> is a project born from the desire to have a simple, private, and fast way to transfer files between devices.</p>

            <p>I'm a developer passionate about creating useful and beautiful applications. Hence, the implementation of WebRTC that you see before you.</p>

            <p>I'm a passionate techy with an unfortunate affinity for tackling the most niche problems using wildly overengineered code.</p>

            <p>This very website is proof of that. Click on my GitHub if my brand of masochism appeals to you.</p>

            <p>I'm currently in my second year of university in Malaysia, pursuing a Computer Science degree with a Data Science specialisation.</p>

            <p>I really wasn’t kidding about the masochism, in case that wasn’t obvious.</p>

            <p>Always open to new and interesting opportunities—so feel free to reach out.</p>

            <p>I’m only as busy as any other Comp Sci student (read: constantly).</p>
            <!-- TODO: Add more content here -->
        </div>
    </div>
</div>

<!-- NEW: Contact Modal -->
<div class="modal-overlay" id="contactModal">
    <div class="invite-modal">
        <div class="modal-header">
            <h3>Contact</h3>
            <button class="modal-close" id="closeContactModal" aria-label="Close modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <p>Feel free to reach out via email:</p>
            <div class="flight-code-display" style="margin-top: 1rem; margin-bottom: 2rem;">
                <a href="mailto:aratahmed@gmail.com" class="code" style="letter-spacing: normal; text-transform: none; font-size: 1.2rem;">aratahmed@gmail.com</a>
            </div>
            <div class="share-actions">
                <button class="share-btn" id="copyEmailBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>
                    Copy Email
                </button>
            </div>
        </div>
    </div>
</div>

<!-- NEW: Terms Modal -->
<div class="modal-overlay" id="termsModal">
    <div class="invite-modal">
        <div class="modal-header">
            <h3>Terms of Service</h3>
            <button class="modal-close" id="closeTermsModal" aria-label="Close modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <p><strong>Last Updated: 27th of June 2025</strong></p>
            <p>Welcome to DropSilk! By using this website and service, you agree to the following terms. Please read them carefully.</p>

            <p><strong>1. Use of Service:</strong> DropSilk is a free, experimental service for peer-to-peer file transfer between devices. You agree to use DropSilk only for lawful purposes. You must not use the service to send, receive, or share any files that are illegal, infringe on the rights of others, or violate any applicable laws or regulations. You are solely responsible for the content of the files you transfer. You must have the legal right to share any files you send using DropSilk.</p>

            <p><strong>2. No Warranty:</strong> DropSilk is provided “as is” and “as available,” without any warranties of any kind, either express or implied. We do not guarantee that the service will be secure, uninterrupted, error-free, or free from viruses or other harmful components. We may modify, suspend, or discontinue the service at any time without notice.</p>

            <p><strong>3. Limitation of Liability:</strong> To the fullest extent permitted by law, DropSilk and its creator(s) are not liable for any direct, indirect, incidental, special, consequential, or exemplary damages, including but not to-do loss of data, loss of profits, or other losses resulting from your use of (or inability to use) the service. You use DropSilk at your own risk.</p>

            <p><strong>4. Privacy:</strong> DropSilk is designed to transfer files directly between users (peer-to-peer) using WebRTC technology. Files are <strong>not</strong> stored on our servers. We do not access, view, or retain the files you transfer. Some minimal information (such as your device’s IP prefix) may be used temporarily to facilitate connections, but is not stored or shared. For more details, please see our Privacy Policy.</p>

            <p><strong>5. User Conduct:</strong> You agree not to attempt to disrupt, hack, or interfere with the operation of DropSilk or its users. You must not use DropSilk to harass, abuse, or harm others.</p>

            <p><strong>6. Changes to These Terms:</strong> We may update these Terms of Service from time to time. If we make significant changes, we will post a notice on the website. Your continued use of DropSilk after changes are posted means you accept the new terms.</p>

            <p><strong>7. Contact:</strong> If you have any questions or concerns about these terms, please contact us at <a href="mailto:aratahmed@gmail.com">aratahmed@gmail.com</a>.</p>

            <p><em>This Terms of Service is provided for informational purposes and does not constitute legal advice. For a production or commercial service, please consult a qualified legal professional.</em></p>
        </div>
    </div>
</div>

<!-- NEW: Privacy Policy Modal -->
<div class="modal-overlay" id="privacyModal">
    <div class="invite-modal">
        <div class="modal-header">
            <h3>Privacy Policy</h3>
            <button class="modal-close" id="closePrivacyModal" aria-label="Close modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <p><strong>Your privacy is paramount.</strong> DropSilk is designed to be as private as possible.</p>
            <p><strong>File Transfers:</strong> Your files are never uploaded to or stored on our servers. They are sent directly from your device to the recipient's device using an encrypted, peer-to-peer (P2P) connection via WebRTC.</p>
            <p><strong>Signaling Server:</strong> To establish a P2P connection, your device and the recipient's device need to exchange connection information (like IP addresses and network capabilities). This exchange is facilitated by our signaling server. The server only sees this temporary metadata and your randomly generated user name; it does not see the content of your files. This connection data is discarded after you leave the session.</p>
            <p><strong>Analytics:</strong> We do not use third-party analytics or tracking cookies. All metrics displayed, such as transfer speed and data volume, are calculated locally on your device and are not sent to our servers.</p>
            <p><em>This is a simplified privacy statement. A full-fledged service would require a more detailed policy.</em></p>
        </div>
    </div>
</div>

<!-- NEW: Security Modal -->
<div class="modal-overlay" id="securityModal">
    <div class="invite-modal">
        <div class="modal-header">
            <h3>Security</h3>
            <button class="modal-close" id="closeSecurityModal" aria-label="Close modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <p>Security is a core feature of DropSilk's design.</p>
            <p><strong>End-to-End Encryption:</strong> All data transferred via WebRTC, including your files, is encrypted end-to-end using DTLS (Datagram Transport Layer Security). This means only you and the recipient can decrypt the data. Our signaling server, or any other intermediary, cannot access the contents of your files.</p>
            <p><strong>No Cloud Storage:</strong> Since your files are never stored on a central server, there is no risk of a cloud data breach exposing your files. The transfer happens directly between the peers in a "flight".</p>
            <p><strong>Flight Codes:</strong> Each transfer session ("flight") is protected by a unique, randomly generated 6-character code. Only users with this code can join the session and receive files.</p>
            <p><strong>Best Practices:</strong> While we implement these security measures, always be sure you are sharing files with a person you know and trust. Verify the flight code with them through a separate, secure channel.</p>
        </div>
    </div>
</div>

<!-- NEW: FAQ Modal -->
<div class="modal-overlay" id="faqModal">
    <div class="invite-modal">
        <div class="modal-header">
            <h3>Frequently Asked Questions</h3>
            <button class="modal-close" id="closeFaqModal" aria-label="Close modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <p><strong>Is there a file size limit?</strong></p>
            <p>Theoretically, no. DropSilk is designed to handle large files. However, performance may depend on your browser, device memory, and network conditions. Some browsers have internal limits on how much data can be buffered.</p>

            <p><strong>Why is the transfer slow?</strong></p>
            <p>Transfer speed depends entirely on the network connection between you and the recipient. For best results, ensure both devices are connected to the same high-speed Wi-Fi network. Transfers over the internet or through cellular data will be slower.</p>

            <p><strong>Are my files stored anywhere?</strong></p>
            <p>No. Your files are sent directly from your browser to the recipient's browser. They are never stored on any server.</p>

            <p><strong>What is a "Flight"?</strong></p>
            <p>A "flight" is our term for a temporary, private file transfer session between two or more devices. You can create a flight to send files, or join an existing flight with a code to receive them.</p>
        </div>
    </div>
</div>

<script>
    // --- NEW: THEME TOGGLE LOGIC ---
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;

    const applyTheme = (theme, persist = true) => {
        body.setAttribute('data-theme', theme);
        if (persist) {
            localStorage.setItem('dropsilk-theme', theme);
        }
        const metaThemeColor = document.querySelector('meta[name="theme-color"]');
        if (theme === 'dark') {
            themeToggle.setAttribute('aria-label', 'Switch to Shades Up (Light Mode)');
            if (metaThemeColor) metaThemeColor.setAttribute('content', '#111113');
        } else {
            themeToggle.setAttribute('aria-label', 'Switch to Shades Down (Dark Mode)');
            if (metaThemeColor) metaThemeColor.setAttribute('content', '#ffffff');
        }
    };

    const toggleTheme = () => {
        const currentTheme = body.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
    };

    const initializeTheme = () => {
        const savedTheme = localStorage.getItem('dropsilk-theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else {
            applyTheme('light', false); // Default to light mode, do not save preference yet
        }
    };

    initializeTheme(); // Apply theme on initial script load to prevent FOUC
    themeToggle.addEventListener('click', toggleTheme);

    // --- CONFIG ---
    // We will replace this URL after deploying the backend in the next step.
    const WEBSOCKET_URL = "wss://dropsilk-server.onrender.com";
    const ICE_SERVERS = [{ urls: "stun:stun.l.google.com:19302" }];

    // --- STATE ---
    let ws, peerConnection, dataChannel, worker;
    let myId = "",
        myName = "",
        currentFlightCode = null,
        isFlightCreator = false,
        connectionType = 'wan',
        peerInfo = null; // NEW: To store connected peer's info
    let fileToSendQueue = [];
    let currentlySendingFile = null;
    const fileIdMap = new Map();

    // --- NEW: METRICS STATE ---
    let totalBytesSent = 0,
        totalBytesReceived = 0,
        metricsInterval = null,
        lastMetricsUpdateTime = 0,
        sentInInterval = 0,
        receivedInInterval = 0;


    // --- UI ELEMENTS ---
    const setupContainer = document.querySelector(".main-content");
    const userNameDisplay = document.getElementById("userNameDisplay");
    const createFlightBtn = document.getElementById("createFlightBtn");
    const joinFlightBtn = document.getElementById("joinFlightBtn");
    const flightCodeInput = document.getElementById("flightCodeInput");

    const dashboard = document.getElementById("dashboard");
    const dashboardFlightCode = document.getElementById("dashboard-flight-code");
    const dashboardFlightStatus = document.getElementById("dashboard-flight-status");
    const leaveFlightBtnDashboard = document.getElementById("leaveFlightBtnDashboard");
    const fileInputTransfer = document.getElementById("fileInput_transfer");
    const sendingQueueDiv = document.getElementById("sending-queue");
    const receiverQueueDiv = document.getElementById("receiver-queue");
    const toastContainer = document.getElementById("toast-container");

    // --- MODIFIED: Dynamic connection panel elements ---
    const connectionPanelTitle = document.getElementById("connection-panel-title");
    const connectionPanelList = document.getElementById("connection-panel-list");


    // --- NEW: METRICS UI ELEMENTS ---
    const metricsSentEl = document.getElementById('metrics-sent');
    const metricsReceivedEl = document.getElementById('metrics-received');
    const metricsSpeedEl = document.getElementById('metrics-speed');

    // This function will be called to switch to the dashboard view
    let enterFlightMode;

    // --- INITIALIZATION & CORE LOGIC ---
    document.addEventListener("DOMContentLoaded", () => {
        const dashboardFlightCodeBtn = document.getElementById('dashboard-flight-code');

        function setFlightCode(code) {
            dashboardFlightCodeBtn.setAttribute('data-code', code);
            dashboardFlightCodeBtn.innerHTML = `<span class="code-text">${code}</span>`;
            if (!dashboardFlightCodeBtn.querySelector('.copy-feedback')) {
                const feedback = document.createElement('span');
                feedback.className = 'copy-feedback';
                feedback.textContent = 'Copied!';
                dashboardFlightCodeBtn.appendChild(feedback);
            }
        }

        dashboardFlightCodeBtn.addEventListener('click', async (e) => {
            e.preventDefault(); e.stopPropagation();
            const code = dashboardFlightCodeBtn.getAttribute('data-code');
            if (!code) return;
            try {
                if (navigator.clipboard && window.isSecureContext) { await navigator.clipboard.writeText(code); }
                else {
                    const textarea = document.createElement('textarea');
                    textarea.value = code; textarea.style.position = 'fixed'; textarea.style.opacity = '0';
                    document.body.appendChild(textarea); textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea);
                }
                dashboardFlightCodeBtn.classList.add('copied');
                setTimeout(() => dashboardFlightCodeBtn.classList.remove('copied'), 1200);
            } catch (error) {
                console.error('Copy failed:', error);
                const codeSpan = dashboardFlightCodeBtn.querySelector('.code-text');
                if (codeSpan) {
                    const range = document.createRange(); range.selectNodeContents(codeSpan);
                    const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
                }
            }
        });

        enterFlightMode = function(flightCode) {
            currentFlightCode = flightCode;
            setupContainer.style.display = "none";
            dashboard.style.display = "flex";
            setFlightCode(flightCode);
            // Re-render the network list to enable invite buttons if not yet connected
            if (!peerInfo) {
                renderNetworkUsersView(lastNetworkUsers || []);
            }
        }

        initializeUser();
        initializeWebSocket();
        setupEventListeners();
    });

    // --- NEW HELPER: IP ADDRESS CHECKS ---
    function isPrivateIp(ip) {
        if (!ip) return false;
        // Exclude CGNAT range 100.64.0.0/10 as it's not a true private network for our purpose
        const cgnatMatch = ip.match(/^100\.(6[4-9]|[7-9][0-9]|1[0-1][0-9]|12[0-7])\./);
        if (cgnatMatch) {
            return false;
        }
        // Check for private IP ranges (RFC 1918)
        return ip.startsWith("10.") ||
            ip.startsWith("192.168.") ||
            ip.match(/^172\.(1[6-9]|2[0-9]|3[0-1])\./);
    }

    // --- NEW: GLOBAL MODAL UTILITIES ---
    async function copyToClipboard(text, button, successText = 'Copied!') {
        try {
            await navigator.clipboard.writeText(text);
            showButtonSuccess(button, successText);
        } catch (error) {
            console.error('Copy failed:', error);
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; textarea.style.opacity = '0';
            document.body.appendChild(textarea); textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showButtonSuccess(button, successText);
        }
    }

    function showButtonSuccess(button, text) {
        if (!button) return;
        const originalText = button.innerHTML;
        button.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
        </svg>
        ${text}
        `;
        button.classList.add('success');
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('success');
        }, 2000);
    }

    // --- NEW: Refactored Modal Setup ---
    function setupAllModalsAndNav() {
        const modals = {
            invite: { overlay: document.getElementById('inviteModal'), trigger: document.getElementById('inviteBtn'), close: document.getElementById('closeInviteModal') },
            about: { overlay: document.getElementById('aboutModal'), trigger: document.getElementById('aboutBtn'), close: document.getElementById('closeAboutModal') },
            contact: { overlay: document.getElementById('contactModal'), trigger: document.getElementById('contactBtn'), close: document.getElementById('closeContactModal') },
            // --- NEW: Footer Modals ---
            terms: { overlay: document.getElementById('termsModal'), trigger: document.getElementById('termsBtn'), close: document.getElementById('closeTermsModal') },
            privacy: { overlay: document.getElementById('privacyModal'), trigger: document.getElementById('privacyBtn'), close: document.getElementById('closePrivacyModal') },
            security: { overlay: document.getElementById('securityModal'), trigger: document.getElementById('securityBtn'), close: document.getElementById('closeSecurityModal') },
            faq: { overlay: document.getElementById('faqModal'), trigger: document.getElementById('faqBtn'), close: document.getElementById('closeFaqModal') }
        };

        const setupModal = (modalConfig) => {
            if (!modalConfig.overlay || !modalConfig.trigger || !modalConfig.close) return;
            const showModal = () => { modalConfig.overlay.classList.add('show'); document.body.style.overflow = 'hidden'; };
            const hideModal = () => { modalConfig.overlay.classList.remove('show'); document.body.style.overflow = ''; };
            modalConfig.trigger.addEventListener('click', showModal);
            modalConfig.close.addEventListener('click', hideModal);
            modalConfig.overlay.addEventListener('click', (e) => { if (e.target === modalConfig.overlay) hideModal(); });
        };

        Object.values(modals).forEach(setupModal);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.show').forEach(m => {
                    m.classList.remove('show');
                    document.body.style.overflow = '';
                });
            }
        });

        // Invite Modal Specifics
        const inviteModalSpecifics = () => {
            const modalFlightCode = document.getElementById('modalFlightCode');
            const qrCanvas = document.getElementById('qrCanvas');
            const copyLinkBtn = document.getElementById('copyLinkBtn');
            const shareNativeBtn = document.getElementById('shareNativeBtn');
            const copyCodeBtn = document.getElementById('copyCodeBtn');

            if (navigator.share) shareNativeBtn.style.display = 'flex';

            modals.invite.trigger.addEventListener('click', () => {
                if (!currentFlightCode) return;
                modalFlightCode.textContent = currentFlightCode;
                generateQRCode();
            });

            function generateQRCode() {
                const url = `https://dropsilk.xyz?code=${currentFlightCode}`;
                if (typeof QRCode === 'undefined') {
                    console.error('QRCode library not loaded');
                    if (qrCanvas) qrCanvas.style.display = 'none'; return;
                }
                const isDarkMode = document.body.getAttribute('data-theme') === 'dark';
                const qrColors = {
                    dark: isDarkMode ? '#5bcefa' : '#18181b', // QR Code dots
                    light: '#00000000' // Transparent background
                };
                QRCode.toCanvas(qrCanvas, url, { width: 200, margin: 2, color: qrColors, errorCorrectionLevel: 'M' }, (err) => {
                    if (err) console.error('QR Code generation error:', err);
                });
            }
            copyLinkBtn.addEventListener('click', () => copyToClipboard(`https://dropsilk.xyz?code=${currentFlightCode}`, copyLinkBtn, 'Link Copied!'));
            copyCodeBtn.addEventListener('click', () => copyToClipboard(currentFlightCode, copyCodeBtn, 'Code Copied!'));
            shareNativeBtn.addEventListener('click', async () => {
                if (navigator.share) {
                    try {
                        await navigator.share({ title: 'Join my DropSilk flight!', text: `Join my file transfer session with code: ${currentFlightCode}`, url: `https://dropsilk.xyz?code=${currentFlightCode}` });
                    } catch (error) { if (error.name !== 'AbortError') copyToClipboard(`https://dropsilk.xyz?code=${currentFlightCode}`, shareNativeBtn, 'Link Copied!'); }
                }
            });
        };

        // Contact Modal Specifics
        const contactModalSpecifics = () => {
            const copyEmailBtn = document.getElementById('copyEmailBtn');
            copyEmailBtn.addEventListener('click', () => copyToClipboard('aratahmed@gmail.com', copyEmailBtn, 'Email Copied!'));
        };

        inviteModalSpecifics();
        contactModalSpecifics();
    }

    function setupDragAndDrop() {
        const dropZone = document.querySelector('.drop-zone');
        let dragCounter = 0;

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => document.addEventListener(eventName, e => {e.preventDefault(); e.stopPropagation();}));
        ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, handleDragEnter, false));
        ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, handleDragLeave, false));
        dropZone.addEventListener('drop', handleDrop, false);

        document.addEventListener('dragenter', e => { if (e.dataTransfer.types.includes('Files')) { dragCounter++; document.body.classList.add('dragging'); }});
        document.addEventListener('dragleave', e => { dragCounter--; if (dragCounter <= 0) { dragCounter = 0; document.body.classList.remove('dragging'); }});
        document.addEventListener('drop', e => { dragCounter = 0; document.body.classList.remove('dragging'); });

        function handleDragEnter(e) {
            dropZone.classList.add('drag-over');
            if (e.dataTransfer.types.includes('Files')) {
                dropZone.classList.add('drag-active');
                if (dropZone.querySelector('p').textContent === 'Drag & Drop files or folders') {
                    dropZone.querySelector('p').textContent = 'Drop your files here!';
                    dropZone.querySelector('.secondary-text').textContent = 'Release to add to queue';
                }
            }
        }

        function handleDragLeave(e) {
            if (!dropZone.contains(e.relatedTarget)) {
                dropZone.classList.remove('drag-over', 'drag-active');
                dropZone.querySelector('p').textContent = 'Drag & Drop files or folders';
                dropZone.querySelector('.secondary-text').textContent = 'or select manually';
            }
        }
        function handleDrop(e) {
            dropZone.classList.remove('drag-over', 'drag-active');
            dropZone.querySelector('p').textContent = 'Drag & Drop files or folders';
            dropZone.querySelector('.secondary-text').textContent = 'or select manually';
            handleFileSelection(e.dataTransfer.files);
        }
    }

    // --- CODE TRUNCATE ---
    const input = document.querySelector('.flight-code-input-wrapper input');
    input.addEventListener('input', function () {
        if (this.value.length > 6) {
            this.value = this.value.slice(0, 6);
        }
    });

    function initializeUser() { myName = generateRandomName(); userNameDisplay.textContent = myName; }
    function generateRandomName() {
        const adjectives = ["Swift", "Clever", "Silent", "Agile", "Brave", "Bright", "Eager", "Bold", "Flying", "Soaring", "Windy", "Cloudy"];
        const nouns = ["Fox", "Jaguar", "Eagle", "Sparrow", "Lion", "Tiger", "River", "Sky", "Aero", "Jet", "Pilot", "Wing"];
        return `${adjectives[Math.floor(Math.random() * adjectives.length)]}${nouns[Math.floor(Math.random() * nouns.length)]}${Math.floor(Math.random() * 900) + 100}`;
    }

    function initializeWebSocket() {
        ws = new WebSocket(WEBSOCKET_URL);
        ws.onopen = () => discoverLocalIpAndRegister(); // Still useful for LAN/WAN detection
        ws.onmessage = async (event) => {
            const msg = JSON.parse(event.data);
            console.log("Received:", msg);
            switch (msg.type) {
                case "registered": myId = msg.id; break;
                case "users-on-network-update":
                    lastNetworkUsers = msg.users;
                    if (!peerInfo) { // Only render if we're not in an active P2P session
                        renderNetworkUsersView(msg.users);
                    }
                    break;
                case "flight-invitation": showInvitationToast(msg.fromName, msg.flightCode); break;
                case "flight-created": enterFlightMode(msg.flightCode); break;
                case "peer-joined":
                    connectionType = msg.connectionType || 'wan';
                    peerInfo = msg.peer;
                    console.log(`Peer ${peerInfo.name} joined. Connection type: ${connectionType}`);
                    handlePeerJoined(msg.flightCode);
                    break;
                case "signal": if (!peerConnection) initializePeerConnection(isFlightCreator); await handleSignal(msg.data); break;
                case "peer-left": handlePeerLeft(); break;
                case "error": console.error("Server error:", msg.message); alert(msg.message); resetState(); break;
            }
        };
        ws.onclose = () => { alert("Connection to server lost. Please refresh."); resetState(); };
        ws.onerror = (error) => console.error("WebSocket error:", error);
    }

    function handlePeerJoined(flightCode) {
        if (!currentFlightCode) { // Receiver joins
            enterFlightMode(flightCode);
        }
        if (!peerConnection) {
            initializePeerConnection(isFlightCreator);
        }
        dashboardFlightStatus.textContent = `Peer Connected! (${connectionType.toUpperCase()} mode)`;
        dashboardFlightStatus.style.color = '#15803d';
        dashboardFlightStatus.style.backgroundColor = '#f0fdf4';
        dashboardFlightStatus.style.borderColor = '#bbf7d0';
        renderInFlightView();
        processFileToSendQueue();
    }

    function handlePeerLeft() {
        console.log("Peer has left the flight.");
        peerInfo = null; // Clear peer info
        resetPeerConnectionState();
        dashboardFlightStatus.textContent = 'Peer disconnected. Waiting...';
        dashboardFlightStatus.style.color = '#d97706';
        dashboardFlightStatus.style.backgroundColor = '#fffbe6';
        dashboardFlightStatus.style.borderColor = '#fde68a';
        // Revert to network view. The server will send a `users-on-network-update` which will
        // trigger the render, but we can be proactive to make the UI feel instant.
        renderNetworkUsersView(lastNetworkUsers);
    }

    // --- FILE TRANSFER & UI LOGIC (WITH FIXES) ---
    let chunkQueue = [], isSending = false, fileReadingDone = false, sentOffset = 0;
    const HIGH_WATER_MARK = 1024 * 1024;
    let incomingFileInfo = null, incomingFileData = [], incomingFileReceived = 0;

    function setupDataChannel() {
        dataChannel.onopen = () => {
            console.log("Data channel opened!");
            // The peer-joined message from the server already handles the UI update.
            // Re-calling handlePeerJoined here would be redundant.

            // NEW: Start tracking metrics when channel opens
            lastMetricsUpdateTime = Date.now();
            if (metricsInterval) clearInterval(metricsInterval);
            metricsInterval = setInterval(updateMetrics, 1000);
        };
        dataChannel.onclose = () => {
            console.log("Data channel closed.");
            handlePeerLeft();
            // NEW: Stop tracking metrics when channel closes
            if (metricsInterval) clearInterval(metricsInterval);
            metricsSpeedEl.textContent = '0 KB/s';
        };
        dataChannel.onerror = (error) => console.error("Data channel error:", error);
        dataChannel.onbufferedamountlow = () => drainQueue();
        dataChannel.onmessage = (event) => {
            // METADATA
            if (typeof event.data === "string" && event.data.startsWith("{")) {
                incomingFileInfo = JSON.parse(event.data);
                incomingFileData = [];
                incomingFileReceived = 0;

                if (receiverQueueDiv.querySelector('.empty-state')) receiverQueueDiv.innerHTML = '';

                const fileId = `file-recv-${Date.now()}`;
                const fileIcon = getFileIcon(incomingFileInfo.name);
                receiverQueueDiv.insertAdjacentHTML('beforeend', `
                    <div class="queue-item" id="${fileId}">
                        <div class="file-icon">${fileIcon}</div>
                        <div class="file-details">
                            <div class="file-details__name" title="${incomingFileInfo.name}"><span>${incomingFileInfo.name}</span></div>
                            <progress class="file-details__progress-bar" value="0" max="1"></progress>
                            <div class="file-details__status"><span class="percent">0%</span></div>
                        </div>
                        <div class="file-action"></div>
                    </div>`);
                fileIdMap.set(incomingFileInfo.name, fileId);
                return;
            }
            // EOF
            if (event.data === "EOF") {
                const received = new Blob(incomingFileData, { type: incomingFileInfo.type });
                const url = URL.createObjectURL(received);
                const fileId = fileIdMap.get(incomingFileInfo.name);
                const fileElement = document.getElementById(fileId);
                if (fileElement) {
                    fileElement.querySelector('.file-action').innerHTML = `<a href="${url}" download="${incomingFileInfo.name}">Download</a>`;
                    fileElement.querySelector('.percent').textContent = 'Complete!';
                }
                return;
            }
            // CHUNK
            const chunkSize = event.data.byteLength || event.data.size || 0;
            // NEW: Update received metrics
            totalBytesReceived += chunkSize;
            receivedInInterval += chunkSize;
            metricsReceivedEl.textContent = formatBytes(totalBytesReceived);

            incomingFileData.push(event.data);
            incomingFileReceived += chunkSize;
            if (incomingFileInfo?.size) {
                const progressValue = incomingFileReceived / incomingFileInfo.size;
                const fileId = fileIdMap.get(incomingFileInfo.name);
                const fileElement = document.getElementById(fileId);
                if (fileElement) {
                    fileElement.querySelector('progress').value = progressValue;
                    fileElement.querySelector('.percent').textContent = `${Math.round(progressValue * 100)}%`;
                }
            }
        };
    }

    function startFileSend(file) {
        currentlySendingFile = file;
        const fileId = fileIdMap.get(file);
        const fileElement = document.getElementById(fileId);
        isSending = true;

        if(fileElement) {
            fileElement.innerHTML = `
                <div class="file-icon">${getFileIcon(file.name)}</div>
                <div class="file-details">
                    <div class="file-details__name" title="${file.name}"><span>${file.name}</span></div>
                    <progress class="file-details__progress-bar" value="0" max="1"></progress>
                    <div class="file-details__status">
                        <span class="percent">0%</span>
                        <span class="status-text">Sending...</span>
                    </div>
                </div>`;
        }

        if (worker) worker.terminate();
        worker = new Worker("sender.worker.js");
        chunkQueue = []; fileReadingDone = false; sentOffset = 0;
        dataChannel.send(JSON.stringify({ name: file.name, type: file.type, size: file.size }));
        worker.onmessage = (e) => {
            const { type, chunk } = e.data;
            if (type === "chunk") {
                chunkQueue.push(chunk);
                drainQueue();
            } else if (type === "done") {
                fileReadingDone = true;
                worker.terminate(); worker = null;
                drainQueue();
            }
        };
        worker.postMessage(file);
    }

    function drainQueue() {
        const file = currentlySendingFile;
        if (!file) return;

        const fileId = fileIdMap.get(file);
        const fileElement = document.getElementById(fileId);

        while (chunkQueue.length > 0) {
            if (dataChannel.bufferedAmount > HIGH_WATER_MARK) return;
            const chunk = chunkQueue.shift();
            dataChannel.send(chunk);

            // NEW: Update sent metrics
            const chunkSize = chunk.byteLength;
            totalBytesSent += chunkSize;
            sentInInterval += chunkSize;
            metricsSentEl.textContent = formatBytes(totalBytesSent);

            sentOffset += chunkSize;
            if (fileElement) {
                const progressValue = sentOffset / file.size;
                fileElement.querySelector('progress').value = progressValue;
                fileElement.querySelector('.percent').textContent = `${Math.round(progressValue * 100)}%`;
            }
        }

        if (fileReadingDone && chunkQueue.length === 0) {
            dataChannel.send("EOF");
            if(fileElement) {
                fileElement.querySelector('.status-text').textContent = 'Sent!';
                fileElement.querySelector('.percent').textContent = `100%`;
            }
            isSending = false;
            currentlySendingFile = null;
            processFileToSendQueue();
        }
    }

    function processFileToSendQueue() {
        if (fileToSendQueue.length > 0 && dataChannel && dataChannel.readyState === 'open' && !isSending) {
            const nextFile = fileToSendQueue.shift();
            startFileSend(nextFile);
        }
    }

    // Define the global file handling function
    function handleFileSelection(files) {
        if (files.length === 0) return;

        // Add success animation for drag and drop
        const dropZone = document.querySelector('.drop-zone');
        if (dropZone) {
            dropZone.style.transform = 'scale(0.98)';
            dropZone.style.transition = 'transform 0.1s ease-out';

            setTimeout(() => {
                dropZone.style.transform = '';
                dropZone.style.transition = '';
            }, 100);
        }

        if (sendingQueueDiv.querySelector('.empty-state')) {
            sendingQueueDiv.innerHTML = '';
        }

        Array.from(files).forEach(file => {
            fileToSendQueue.push(file);
            const fileId = `send-${Date.now()}-${Math.random()}`;
            fileIdMap.set(file, fileId);

            sendingQueueDiv.insertAdjacentHTML('beforeend', `
            <div class="queue-item" id="${fileId}" style="opacity: 0; transform: translateY(10px);">
                <div class="file-icon">${getFileIcon(file.name)}</div>
                <div class="file-details">
                    <div class="file-details__name" title="${file.name}"><span>${file.name}</span></div>
                    <div class="file-details__status"><span class="status-text">Queued</span></div>
                </div>
            </div>
        `);

            // Animate the new file item in
            const fileElement = document.getElementById(fileId);
            setTimeout(() => {
                fileElement.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                fileElement.style.opacity = '1';
                fileElement.style.transform = 'translateY(0)';
            }, 50);
        });

        processFileToSendQueue();
        console.log(`Added ${files.length} file(s) to the sending queue`);
    }

    // --- EVENT LISTENERS & UI HELPERS ---
    function setupEventListeners() {
        createFlightBtn.onclick = () => { isFlightCreator = true; ws.send(JSON.stringify({ type: "create-flight" })); };
        joinFlightBtn.onclick = () => {
            const code = flightCodeInput.value.trim().toUpperCase();
            if (code) { isFlightCreator = false; ws.send(JSON.stringify({ type: "join-flight", flightCode: code })); }
            else { alert("Please enter a Flight Code to join."); }
        };
        leaveFlightBtnDashboard.onclick = () => { location.reload(); };

        fileInputTransfer.onchange = () => {
            if (fileInputTransfer.files.length > 0) {
                handleFileSelection(fileInputTransfer.files);
                fileInputTransfer.value = ""; // Clear the input
            }
        };

        // --- MODIFIED: Event delegation for invite buttons on the dynamic panel ---
        connectionPanelList.addEventListener('click', (e) => {
            const inviteBtn = e.target.closest('.invite-user-btn');
            if (inviteBtn && !inviteBtn.disabled) {
                const inviteeId = inviteBtn.dataset.inviteeId;
                if (inviteeId && currentFlightCode) {
                    ws.send(JSON.stringify({
                        type: 'invite-to-flight',
                        inviteeId: inviteeId,
                        flightCode: currentFlightCode
                    }));
                    // Provide feedback
                    inviteBtn.textContent = 'Invited';
                    inviteBtn.disabled = true;
                    setTimeout(() => {
                        inviteBtn.textContent = 'Invite';
                        // The button will be re-enabled on the next user list update if still applicable
                    }, 3000);
                }
            }
        });

        document.getElementById('shareAppBtn').onclick = () => document.getElementById('inviteBtn').click();

        // Initialize drag and drop and ALL modals
        setupDragAndDrop();
        setupAllModalsAndNav();
    }



    // --- NEW: METRICS FUNCTIONS ---
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    function updateMetrics() {
        const now = Date.now();
        const elapsedSeconds = (now - lastMetricsUpdateTime) / 1000;
        if (elapsedSeconds === 0) return;

        const totalBytesInInterval = sentInInterval + receivedInInterval;
        const speed = totalBytesInInterval / elapsedSeconds;

        metricsSpeedEl.textContent = `${formatBytes(speed)}/s`;

        // Reset for the next interval
        lastMetricsUpdateTime = now;
        sentInInterval = 0;
        receivedInInterval = 0;
    }


    function getFileIcon(fileName) {
        const extension = fileName.split('.').pop().toLowerCase();

        // Image
        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension)) return `<svg viewBox="0 0 20 20" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="14" height="12" rx="2" fill="#e3f7fd" stroke="var(--c-primary)"/><circle cx="7" cy="8" r="1.5" fill="var(--c-primary)"/><path d="M3 16l4-5 3 4 4-6 3 7" stroke="var(--c-secondary)" stroke-width="1.5" fill="none"/></svg>`;
        // Video
        if (['mp4', 'mov', 'avi', 'mkv', 'm4v'].includes(extension)) return `<svg viewBox="0 0 28 28" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4.2" y="5.6" width="19.6" height="16.8" rx="2.8" ry="2.8" fill="#f5eafd" stroke="var(--c-secondary)"/><polygon points="9.2 10 17.9 14.2 9.2 18.4" fill="var(--c-primary)"/></svg>`;
        // Audio
        if (['mp3', 'wav', 'ogg', 'm4a'].includes(extension)) return `<svg viewBox="0 0 28 28" width="28" height="28" fill="none"><rect x="4.2" y="5.6" width="19.6" height="16.8" rx="2.8" ry="2.8" fill="#eafdff" stroke="var(--c-primary)"/><path d="M11.3,9.6v7.3c-.4-.3-.8-.4-1.4-.4-1.1,0-2.1.8-2.1,1.7s.9,1.7,2.1,1.7,2.1-.8,2.1-1.7v-6.8l6.5-.8v5.5c-.4-.3-.8-.4-1.4-.4-1.1,0-2.1.8-2.1,1.7s.9,1.7,2.1,1.7,2.1-.8,2.1-1.7v-8.5c0-.5-.5-.9-1-.9l-6.1.6c-.5,0-.8.4-.8.9Z" fill="var(--c-secondary)"/></svg>`;
        // PDF/Document
        if (['pdf'].includes(extension)) return `<svg viewBox="0 0 20 20" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="14" height="12" rx="2" fill="#fff" stroke="var(--c-primary)"/><rect x="6" y="8" width="8" height="1.5" fill="var(--c-secondary)"/><rect x="6" y="11" width="5" height="1.5" fill="var(--c-secondary)"/></svg>`;
        // Archive/Zip
        if (['zip', 'rar', '7z'].includes(extension)) return `<svg viewBox="0 0 28 28" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4.2" y="5.6" width="19.6" height="16.8" rx="2.8" ry="2.8" fill="#fffaf7" stroke="var(--c-secondary)"/><rect x="12.6" y="8.4" width="2.8" height="11.2" fill="var(--c-primary)"/><rect x="9.8" y="14" width="8.4" height="2.8" fill="var(--c-secondary)"/></svg>`;
        // Generic File
        return `<svg viewBox="0 0 28 28" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4.2" y="5.6" width="19.6" height="16.8" rx="2.8" ry="2.8" fill="#f4f4f5" stroke="var(--c-primary)"/><path d="M12.2,16v-.4c0-.6.1-1.2.3-1.6.2-.4.7-.8,1.4-1.2.6-.3.9-.6,1.1-.8.2-.2.3-.4.3-.7s-.1-.6-.4-.8c-.3-.2-.7-.3-1.1-.3s-.9.1-1.2.3c-.3.2-.5.5-.6.8h-2.5c0-.7.3-1.3.7-1.8s.9-.9,1.5-1.2,1.4-.5,2.2-.5,1.5.1,2.1.4,1.1.7,1.4,1.2c.3.5.5,1.1.5,1.8s-.2,1.1-.5,1.6c-.3.5-.8.9-1.5,1.3-.5.3-.9.6-1,.8-.2.2-.2.5-.2.7v.2h-2.5ZM13.5,16.9c.4,0,.8.2,1.1.5.3.3.5.7.5,1.1s-.2.8-.5,1.1c-.3.3-.7.5-1.1.5s-.8-.2-1.1-.5c-.3-.3-.5-.7-.5-1.1s.2-.8.5-1.1c.3-.3.7-.5,1.1-.5Z" fill="var(--c-secondary)" stroke="var(--c-primary)" stroke-linecap="round" stroke-linejoin="round" stroke-width="0.8"/></svg>`;
    }

    // --- NEW: Keep track of the last user list to re-render it ---
    let lastNetworkUsers = [];
    function renderNetworkUsersView(users) {
        connectionPanelTitle.textContent = "Users on Your Network";
        connectionPanelList.innerHTML = '';
        if (users.length === 0) {
            connectionPanelList.innerHTML = '<div class="empty-state">No other users found on your network.</div>';
            return;
        }

        const isInFlight = !!currentFlightCode;
        users.forEach(user => {
            const userEl = document.createElement('div');
            userEl.className = 'network-user-item';
            userEl.innerHTML = `
                <div class="network-user-details">
                    <span class="network-user-name">${user.name}</span>
                    <span class="network-user-id">ID: ${user.id}</span>
                </div>
                <button
                    class="btn btn-primary invite-user-btn"
                    data-invitee-id="${user.id}"
                    ${!isInFlight ? 'disabled title="Create or join a flight to invite users"' : ''}>
                    Invite
                </button>
            `;
            connectionPanelList.appendChild(userEl);
        });
    }

    // --- NEW: Renders the "In Flight" view ---
    function renderInFlightView() {
        if (!peerInfo) return; // Safety check
        connectionPanelTitle.textContent = "In Flight With";
        connectionPanelList.innerHTML = `
            <div class="inflight-user-item">
                <div class="inflight-user-details">
                    <span class="inflight-user-name">${myName}</span>
                    <span class="user-badge">You</span>
                </div>
                <span class="inflight-user-id">ID: ${myId}</span>
            </div>
            <div class="inflight-user-item">
                <div class="inflight-user-details">
                    <span class="inflight-user-name">${peerInfo.name}</span>
                </div>
                <span class="inflight-user-id">ID: ${peerInfo.id}</span>
            </div>
        `;
    }

    // --- NEW: Show a toast notification for an invitation ---
    function showInvitationToast(fromName, flightCode) {
        const toastId = `toast-${Date.now()}`;
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.id = toastId;
        toast.innerHTML = `
            <div class="toast-header">
                <strong>Flight Invitation</strong>
                <button class="toast-close">&times;</button>
            </div>
            <div class="toast-body">
                <b>${fromName}</b> has invited you to a flight.
            </div>
            <div class="toast-actions">
                <button class="btn btn-secondary toast-decline">Decline</button>
                <button class="btn btn-primary toast-join" data-flight-code="${flightCode}">Join</button>
            </div>
        `;

        toastContainer.appendChild(toast);

        // Animate in
        setTimeout(() => toast.classList.add('show'), 100);

        const removeToast = () => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        };

        const autoDismiss = setTimeout(removeToast, 10000); // Auto-dismiss after 10s

        toast.addEventListener('click', (e) => {
            if (e.target.matches('.toast-join')) {
                const code = e.target.dataset.flightCode;
                isFlightCreator = false; // Important: set flag when joining via invite
                ws.send(JSON.stringify({ type: "join-flight", flightCode: code }));
                clearTimeout(autoDismiss);
                removeToast();
            } else if (e.target.matches('.toast-decline, .toast-close')) {
                clearTimeout(autoDismiss);
                removeToast();
            }
        });
    }

    function resetState() {
        if (metricsInterval) clearInterval(metricsInterval);
        resetPeerConnectionState();
        currentFlightCode = null; isFlightCreator = false; connectionType = 'wan'; fileToSendQueue = [];
        peerInfo = null; // Also reset peerInfo
        setupContainer.style.display = "flex";
        dashboard.style.display = "none";
        flightCodeInput.value = "";
        fileInputTransfer.value = "";
        sendingQueueDiv.innerHTML = '<div class="empty-state">Select files to send</div>';
        receiverQueueDiv.innerHTML = '<div class="empty-state">Waiting for incoming files</div>';

        // NEW: Reset metrics UI and state
        totalBytesSent = 0;
        totalBytesReceived = 0;
        metricsSentEl.textContent = '0.00 GB';
        metricsReceivedEl.textContent = '0.00 GB';
        metricsSpeedEl.textContent = '0 KB/s';

        initializeUser();
    }
    function resetPeerConnectionState() {
        if (peerConnection) { peerConnection.close(); peerConnection = null; }
        if (worker) { worker.terminate(); worker = null; }
        if (metricsInterval) clearInterval(metricsInterval);
        dataChannel = null; chunkQueue = []; isSending = false;
        fileReadingDone = false; sentOffset = 0; incomingFileInfo = null;
        incomingFileData = []; incomingFileReceived = 0; currentlySendingFile = null;
        metricsSpeedEl.textContent = '0 KB/s';
    }

    // --- WEBRTC & SERVER COMMUNICATION FUNCTIONS ---
    discoverLocalIpAndRegister = function() {
        // This function is now mainly for the client to register its name.
        // The local IP discovery part is less critical but can still help the server's LAN/WAN detection heuristic.
        console.log("Registering user details with server...");
        ws.send(JSON.stringify({
            type: "register-details",
            name: myName,
            // We can still attempt to get local IP for the LAN/WAN detection, but don't rely on it for grouping.
            localIpPrefix: "unknown",
            localIp: "unknown"
        }));
    }

    initializePeerConnection = function(isOfferer) {
        if (peerConnection) return;
        let pcConfig;
        if (connectionType === 'lan') {
            console.log("LAN connection mode: Using host candidates only (no STUN).");
            pcConfig = { iceServers: [] };
        } else {
            console.log("WAN connection mode: Using STUN servers.");
            pcConfig = { iceServers: ICE_SERVERS };
        }

        peerConnection = new RTCPeerConnection(pcConfig);

        peerConnection.onicecandidate = (event) => { if (event.candidate) ws.send(JSON.stringify({ type: "signal", data: { candidate: event.candidate }, })); };
        peerConnection.onconnectionstatechange = () => {
            console.log("Peer connection state:", peerConnection.connectionState);
            if (peerConnection.connectionState === "disconnected" || peerConnection.connectionState === "failed" || peerConnection.connectionState === "closed") {
                console.log("Peer connection lost or failed. Resetting state.");
                handlePeerLeft();
            }
        };
        if (isOfferer) {
            dataChannel = peerConnection.createDataChannel("fileTransfer");
            setupDataChannel();
            peerConnection.createOffer().then((offer) => peerConnection.setLocalDescription(offer)).then(() => { ws.send(JSON.stringify({ type: "signal", data: { sdp: peerConnection.localDescription }, })); });
        } else { peerConnection.ondatachannel = (event) => { dataChannel = event.channel; setupDataChannel(); }; }
    }
    handleSignal = async function(data) {
        if (!peerConnection) { console.warn("Received signal before peerConnection initialized. Initializing now."); initializePeerConnection(isFlightCreator); }
        if (data.sdp) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                if (data.sdp.type === "offer") {
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    ws.send(JSON.stringify({ type: "signal", data: { sdp: peerConnection.localDescription }, }));
                }
            } catch (error) { console.error("Error setting remote description or creating answer:", error); }
        } else if (data.candidate) {
            try { await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate)); } catch (error) { console.error("Error adding ICE candidate:", error); }
        }
    }

</script>
<script src="https://unpkg.com/qrcode@1.4.4/build/qrcode.min.js"></script>
</body>
</html>
